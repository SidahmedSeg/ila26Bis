// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/@prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id                String    @id @default(uuid()) @db.Uuid
  email             String    @unique @db.VarChar(255)
  passwordHash      String?   @map("password_hash") @db.VarChar(255)
  fullName          String    @map("full_name") @db.VarChar(255)
  googleOAuthId     String?   @unique @map("google_oauth_id") @db.VarChar(255)
  emailVerified     Boolean   @default(false) @map("email_verified")
  emailVerifiedAt   DateTime? @map("email_verified_at")
  stripeCustomerId  String?   @unique @map("stripe_customer_id") @db.VarChar(255)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  tenantMemberships TenantMembership[]
  userFeatures      UserFeature[]
  ownedTenants      Tenant[] @relation("TenantOwner")
  uploadedDocuments Document[]

  @@index([email])
  @@map("users")
}

// Admin User Model
model AdminUser {
  id          String    @id @default(uuid()) @db.Uuid
  email       String    @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role        AdminRole @default(ADMIN)
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([email])
  @@map("admin_users")
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
}

// Tenant (Enterprise) Model
model Tenant {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(255)
  siret           String   @unique @db.VarChar(14)
  kbis            String?  @db.VarChar(255)
  activityDomainId String? @map("activity_domain_id") @db.Uuid
  specialityId    String?  @map("speciality_id") @db.Uuid
  address         Json?
  creationDate    DateTime @default(now()) @map("creation_date")
  logoUrl         String?  @map("logo_url") @db.VarChar(500)
  coverImageUrl   String?  @map("cover_image_url") @db.VarChar(500)
  status          TenantStatus @default(ACTIVE)
  ownerId         String   @map("owner_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  owner           User     @relation("TenantOwner", fields: [ownerId], references: [id])
  subscription    Subscription?
  memberships     TenantMembership[]
  documents       Document[]
  payments        Payment[]
  roles           Role[]
  activityDomain  ActivityDomain? @relation(fields: [activityDomainId], references: [id])
  speciality      Speciality? @relation(fields: [specialityId], references: [id])

  @@index([siret])
  @@index([ownerId])
  @@index([status])
  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  NOT_ACTIVE
}

// Tenant Membership Model
model TenantMembership {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  roleId     String   @map("role_id") @db.Uuid
  isOwner    Boolean  @default(false) @map("is_owner")
  invitedBy  String?  @map("invited_by") @db.Uuid
  invitedAt  DateTime? @map("invited_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id])

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@map("tenant_memberships")
}

// Role Model
model Role {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String?  @map("tenant_id") @db.Uuid
  name        String   @db.VarChar(100)
  isDefault   Boolean  @default(false) @map("is_default")
  isSystem    Boolean  @default(false) @map("is_system")
  description String?  @db.Text
  createdBy   String?  @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  memberships TenantMembership[]

  @@index([tenantId])
  @@map("roles")
}

// Role Permission Model
model RolePermission {
  id         String        @id @default(uuid()) @db.Uuid
  roleId     String        @map("role_id") @db.Uuid
  module     String        @db.VarChar(100)
  permission PermissionType
  createdAt  DateTime      @default(now()) @map("created_at")

  // Relations
  role       Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, module, permission])
  @@index([roleId])
  @@map("role_permissions")
}

enum PermissionType {
  READ
  WRITE
}

// Subscription Model
model Subscription {
  id                    String              @id @default(uuid()) @db.Uuid
  tenantId              String              @unique @map("tenant_id") @db.Uuid
  planTier              PlanTier            @map("plan_tier")
  billingPeriod         BillingPeriod?      @map("billing_period")
  stripeSubscriptionId  String?             @unique @map("stripe_subscription_id") @db.VarChar(255)
  stripeCustomerId      String              @map("stripe_customer_id") @db.VarChar(255)
  maxUsers              Int                 @default(1) @map("max_users")
  status                SubscriptionStatus  @default(ACTIVE)
  currentPeriodStart    DateTime            @map("current_period_start")
  currentPeriodEnd      DateTime            @map("current_period_end")
  cancelAtPeriodEnd     Boolean             @default(false) @map("cancel_at_period_end")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  tenant                Tenant @relation(fields: [tenantId], references: [id])
  payments              Payment[]

  @@index([tenantId])
  @@index([status])
  @@map("subscriptions")
}

enum PlanTier {
  FREE
  PAID_TIER_1
  PAID_TIER_2
}

enum BillingPeriod {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
}

// Payment Model
model Payment {
  id                  String        @id @default(uuid()) @db.Uuid
  tenantId            String        @map("tenant_id") @db.Uuid
  subscriptionId      String        @map("subscription_id") @db.Uuid
  stripePaymentIntentId String      @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeInvoiceId     String?       @map("stripe_invoice_id") @db.VarChar(255)
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("EUR") @db.VarChar(3)
  status              PaymentStatus
  paymentMethod       String?       @map("payment_method") @db.VarChar(50)
  invoiceUrl          String?       @map("invoice_url") @db.VarChar(500)
  paidAt              DateTime?     @map("paid_at")
  createdAt           DateTime      @default(now()) @map("created_at")

  // Relations
  tenant              Tenant        @relation(fields: [tenantId], references: [id])
  subscription        Subscription  @relation(fields: [subscriptionId], references: [id])

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([status])
  @@map("payments")
}

enum PaymentStatus {
  SUCCEEDED
  FAILED
  PENDING
  REFUNDED
}

// User Feature (Mobility) Model
model UserFeature {
  id                    String            @id @default(uuid()) @db.Uuid
  userId                String            @map("user_id") @db.Uuid
  featureType           FeatureType       @default(MOBILITY) @map("feature_type")
  stripeProductId       String            @map("stripe_product_id") @db.VarChar(255)
  stripeSubscriptionId  String            @unique @map("stripe_subscription_id") @db.VarChar(255)
  status                UserFeatureStatus
  currentPeriodStart    DateTime          @map("current_period_start")
  currentPeriodEnd      DateTime          @map("current_period_end")
  cancelAtPeriodEnd     Boolean           @default(false) @map("cancel_at_period_end")
  activatedAt           DateTime          @map("activated_at")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  // Relations
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("user_features")
}

enum FeatureType {
  MOBILITY
}

enum UserFeatureStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  EXPIRED
}

// Document Model
model Document {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String   @db.VarChar(255)
  categoryId  String   @map("category_id") @db.Uuid
  fileUrl     String   @map("file_url") @db.VarChar(500)
  fileSize    Int      @map("file_size")
  mimeType    String   @map("mime_type") @db.VarChar(100)
  uploadedBy  String   @map("uploaded_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category    DocumentCategory @relation(fields: [categoryId], references: [id])
  uploadedByUser User  @relation(fields: [uploadedBy], references: [id])

  @@index([tenantId])
  @@index([categoryId])
  @@map("documents")
}

// Document Category Model
model DocumentCategory {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique @db.VarChar(100)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  documents   Document[]

  @@map("document_categories")
}

// Activity Domain Model
model ActivityDomain {
  id          String      @id @default(uuid()) @db.Uuid
  name        String      @unique @db.VarChar(255)
  code        String?     @unique @db.VarChar(50)
  description String?     @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  tenants     Tenant[]
  specialities Speciality[]

  @@map("activity_domains")
}

// Speciality Model
model Speciality {
  id              String          @id @default(uuid()) @db.Uuid
  activityDomainId String         @map("activity_domain_id") @db.Uuid
  name            String          @db.VarChar(255)
  description     String?         @db.Text
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  activityDomain  ActivityDomain  @relation(fields: [activityDomainId], references: [id], onDelete: Cascade)
  tenants         Tenant[]

  @@index([activityDomainId])
  @@map("specialities")
}

// OTP Model
model OTP {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @db.VarChar(255)
  code      String   @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@map("otps")
}

// Feature Flag Model
model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  planFeatures PlanFeature[]

  @@map("feature_flags")
}

// Plan Feature Model
model PlanFeature {
  id            String   @id @default(uuid()) @db.Uuid
  planTier      PlanTier @map("plan_tier")
  featureFlagId String   @map("feature_flag_id") @db.Uuid
  isEnabled     Boolean  @default(true) @map("is_enabled")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  featureFlag   FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@unique([planTier, featureFlagId])
  @@index([planTier])
  @@map("plan_features")
}

